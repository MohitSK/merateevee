<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M3U Player – HLS.js + Shaka</title>
  <!-- Icons -->
  <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23000'/><text x='50' y='60' font-size='60' text-anchor='middle' fill='%23fff'>▶</text></svg>">
  <!-- External libs -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.9.6/shaka-player.compiled.min.js"></script>
  <style>
    :root{
      --bg:#0b0b0f; --bg-soft:#111116; --panel:#16161d; --accent:#e50914; --text:#ececf1; --muted:#a0a0b8; --card:#1b1b24;
      --tag-hls:#2ecc71; --tag-dash:#3498db; --tag-unk:#f1c40f;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial}
    a{color:inherit}
    button{cursor:pointer}

    /* Layout */
    .app{max-width:1200px;margin:0 auto;padding:24px}
    .header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    .brand{font-weight:800;letter-spacing:.3px}
    .spacer{flex:1}
    .ghost{background:transparent;border:1px solid #2a2a36;color:var(--text);border-radius:999px;padding:8px 14px}

    /* Panels */
    .panel{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}

	.channels-header {
	  margin-bottom: 14px;
	  background: var(--panel);
	  border-radius: var(--radius);
	  padding: 12px 16px;
	}

	#searchChannel:focus {
	  outline: none;
	  border-color: var(--accent);
	  width: 240px;
	  transition: width 0.2s;
	}

	/* Favorite provider card styling */
	.fav-card {
	  background: linear-gradient(135deg, #2c2c36, #1b1b24);
	  border: 1px solid gold;
	  color: #ffe082;
	  cursor: pointer;
	  transition: transform 0.2s, background 0.2s;
	}

	.fav-card:hover {
	  background: linear-gradient(135deg, #3a3a46, #20202a);
	  transform: translateY(-3px);
	}


    /* Provider list */
    .providers-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .providers{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
    .prov-card{background:var(--card);border:1px solid #242433;border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:10px;box-shadow:var(--shadow)}
    .prov-name{font-weight:700}
	
	.prov-meta {
	  color: var(--muted);
	  font-size: 13px;

	  /* Prevent long URLs from overflowing */
	  word-break: break-all;
	  overflow-wrap: anywhere;
	  display: block;
	  max-width: 100%;
	}

    .prov-actions{display:flex;gap:8px}
    .btn{border:none;padding:10px 14px;border-radius:12px;background:#2a2a36;color:#fff}
    .btn:hover{background:#323247}
    .btn-danger{background:#521b1f}
    .btn-danger:hover{background:#6a242a}
    .btn-primary{background:var(--accent)}
    .btn-primary:hover{filter:brightness(1.1)}
	
	.icon-btn {
	  background: transparent;
	  border: none;
	  font-size: 18px;
	  color: #ccc;
	  cursor: pointer;
	  transition: transform 0.2s, color 0.2s;
	}
	.icon-btn:hover {
	  transform: rotate(90deg);
	  color: var(--accent);
	}

    .float-add{position:fixed;right:24px;bottom:24px;width:56px;height:56px;border-radius:50%;display:grid;place-items:center;background:var(--accent);box-shadow:var(--shadow);border:none;font-size:26px;color:#fff}

    /* Channels grid */
    .channels-grid {
	  display: grid;
	  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
	  gap: 16px;
	}

	/* Force at least 3 columns in portrait phones */
	@media (max-width: 720px) {
	  .channels-grid {
		grid-template-columns: repeat(3, 1fr);
	  }
	  .card .thumb {
		height: 100px;
		overflow:hidden
	  }
	  .title {
		font-size: 13px;
	  }
	}

    .card{background:var(--card);border:1px solid #242433;border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .thumb{background:#0e0e12;display:grid;place-items:center;height:120px}
    
	/* Ensure all channel logos fit neatly within the thumbnail box */
	.thumb {
	  position: relative;
	  background: #0e0e12;
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  height: 120px;            /* fixed thumbnail height */
	  overflow: hidden;         /* hides anything going out of bounds */
	  border-bottom: 1px solid #242433;
	}

	.thumb img {
	  width: 100%;
	  height: 100%;
	  object-fit: contain;      /* keeps aspect ratio without cropping */
	  object-position: center;  /* centers logo */
	  display: block;
	  max-width: 100%;
	  max-height: 100%;
	}

	
	.fav-btn {
	  position: absolute;
	  top: 6px;
	  right: 6px;
	  background: transparent;
	  border: none;
	  font-size: 20px;
	  color: #ccc;
	  cursor: pointer;
	  transition: transform 0.2s, color 0.2s;
	}
	.fav-btn:hover {
	  transform: scale(1.2);
	  color: gold;
	}
	.fav-btn.active {
	  color: gold;
	}
	.card:hover .fav-btn {
	  opacity: 1;
	}
	.thumb {
	  position: relative;
	}
	
	/* Position HLS/DASH badge at top-left corner */
	.stream-tag {
	  position: absolute;
	  top: 6px;
	  left: 6px;
	  font-size: 11px;
	  font-weight: 600;
	  padding: 3px 7px;
	  border-radius: 6px;
	  color: #fff;
	  backdrop-filter: blur(4px);
	  text-shadow: 0 1px 2px rgba(0,0,0,0.4);
	}

	/* Distinct colors for types */
	.stream-tag.hls {
	  background: rgba(46, 204, 113, 0.85); /* green */
	}
	.stream-tag.dash {
	  background: rgba(52, 152, 219, 0.85); /* blue */
	}
	.stream-tag.unknown {
	  background: rgba(241, 196, 15, 0.85); /* yellow */
	}


	
    .card-body{padding:12px;display:flex;align-items:center;gap:8px}
    .title{font-weight:700;flex:1}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px}
    .tag.hls{background:var(--tag-hls);color:#071f11}
    .tag.dash{background:var(--tag-dash);color:#041321}
    .tag.unk{background:var(--tag-unk);color:#221a02}

    /* Views */
    .view{display:none}
    .view.active{display:block}

    /* Player */
    .player-wrap{position:relative;background:#000;border-radius:16px;overflow:hidden}
    .player-header{display:flex;align-items:center;gap:10px;padding:10px;background:linear-gradient(180deg, rgba(0,0,0,.7), rgba(0,0,0,.2));position:absolute;left:0;right:0;top:0;z-index:3}
    .back {
	  background: rgba(255, 255, 255, 0.15);
	  border: 1px solid rgba(255, 255, 255, 0.3);
	  color: #fff;
	  padding: 8px 14px;
	  border-radius: 12px;
	  font-weight: 600;
	  backdrop-filter: blur(6px);
	}


    .player-title{font-weight:700}
    .player-type{margin-left:auto}
    video{width:100%;height:70vh;background:#000;object-fit:contain}

    /* Settings popover */
	.gear {
	  margin-left: 8px;
	  background: rgba(255, 255, 255, 0.15);
	  border: 1px solid rgba(255, 255, 255, 0.3);
	  color: #fff;
	  padding: 8px 12px;
	  border-radius: 12px;
	  backdrop-filter: blur(6px);
	}
    .settings{position:absolute;right:12px;top:56px;background:#0f0f14;border:1px solid #2a2a36;border-radius:14px;box-shadow:var(--shadow);padding:12px;min-width:260px;z-index:4;display:none}
    .settings.open{display:block}
    .settings h4{margin:6px 0 10px 0;font-size:14px;color:#cfcfe6}
    .field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
    .field label{font-size:12px;color:var(--muted)}
    select, input[type="text"], input[type="url"]{background:#161620;border:1px solid #2a2a36;color:#fff;border-radius:10px;padding:8px}

    /* Modal (Netflix-style) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:10}
    .modal{background:#0f0f14;border:1px solid #2a2a36;border-radius:16px;box-shadow:var(--shadow);width:min(520px,92%);padding:18px}
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .radio-row{display:flex;gap:12px;margin:8px 0}
    .hidden{display:none !important}
    .hint{font-size:12px;color:var(--muted)}

    /* Empty states */
    .empty{border:1px dashed #2a2a36;border-radius:16px;padding:22px;text-align:center;color:var(--muted)}

    @media (max-width:720px){
      video{height:56vh}
      .player-header{gap:6px}
      .player-title{font-size:14px}
    }
	
	.header {
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  margin-bottom: 16px;
	}
	
	/* ---------------- Toast Message ---------------- */
	.toast {
	  position: fixed;
	  bottom: 24px;
	  left: 50%;
	  transform: translateX(-50%);
	  background: rgba(0, 0, 0, 0.8);
	  color: #fff;
	  padding: 10px 18px;
	  border-radius: 10px;
	  font-size: 14px;
	  opacity: 0;
	  pointer-events: none;
	  transition: opacity 0.4s ease, bottom 0.4s ease;
	  z-index: 2000;
	}

	.toast.show {
	  opacity: 1;
	  bottom: 40px;
	}


  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="brand">M3U Player</div>
      <div class="spacer"></div>
    </div>


    <!-- PROVIDERS VIEW -->
    <section id="viewProviders" class="view active">
      <div class="panel">
        <div class="providers-header">
          <h2 style="margin:0">Providers</h2>
          <div class="hint">Saved to your browser (localStorage)</div>
        </div>
        <div id="providersList" class="providers"></div>
        <div id="providersEmpty" class="empty hidden">No providers yet. Click the <b>+</b> button to add one from URL or File.</div>
      </div>
      <button id="btnAddProvider" class="float-add" title="Add Provider" aria-label="Add Provider">+</button>
    </section>

    <!-- CHANNELS VIEW -->
    <section id="viewChannels" class="view">
		<div class="panel channels-header">
		  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
			<button id="backToProviders" class="btn">← Providers</button>

			<!-- Provider name + small refresh icon -->
			<div style="display:flex;align-items:center;gap:6px;">
			  <div id="currentProviderName" style="font-weight:700"></div>
			  <button id="refreshProvider" class="icon-btn" title="Refresh">⟳</button>
			</div>

			<div class="spacer"></div>

			<input
			  type="text"
			  id="searchChannel"
			  placeholder="Search channels..."
			  style="background:#161620;border:1px solid #2a2a36;color:#fff;padding:8px 10px;border-radius:10px;width:200px;"
			/>
			<label style="display:flex;align-items:center;gap:6px;color:#ccc;font-size:14px;">
			  <input type="checkbox" id="toggleFavorites" />
			  <span>Show Favorites Only</span>
			</label>
		  </div>
		</div>


      <div id="channelsGrid" class="channels-grid"></div>
      <div id="channelsEmpty" class="empty hidden">Could not load or parse channels from this provider.</div>
    </section>

    <!-- PLAYER VIEW -->
    <section id="viewPlayer" class="view">
      <div class="player-wrap">
		<div class="player-header">
		  <button id="backToChannels" class="back">← Back</button>
		  <div id="playerTitle" class="player-title"></div>
		  <span id="playerTypeBadge" class="tag unk player-type">UNKNOWN</span>

		  <!-- ⭐ Favorite button during playback -->
		  <button id="favInPlayer" class="gear" title="Add to Favorites">☆</button>

		  <button id="btnSettings" class="gear" title="Player settings">⚙</button>
		</div>

        <video id="video" playsinline controls></video>
        <div id="settingsPanel" class="settings" role="dialog" aria-modal="true">
          <h4>Player Settings</h4>
          <div class="field">
            <label for="selAspect">Display mode</label>
            <select id="selAspect">
              <option value="contain">Best fit</option>
              <option value="cover">Fill screen</option>
              <option value="none">Original</option>
            </select>
          </div>
          <div class="field">
            <label for="selQuality">Video quality</label>
            <select id="selQuality"></select>
          </div>
          <div class="field">
            <label for="selAudio">Audio track</label>
            <select id="selAudio"></select>
          </div>
          <div class="field">
            <label><input type="checkbox" id="chkSubs"> Subtitles (text tracks)</label>
            <select id="selSubs"></select>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Add/Edit Provider Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <h3 id="modalTitle" style="margin:0">Add Provider</h3>
        <button id="modalClose" class="ghost">✕</button>
      </div>
      <div class="radio-row">
        <label><input type="radio" name="provType" value="url" checked> From URL</label>
        <label><input type="radio" name="provType" value="file"> From File</label>
      </div>
      <div class="field"><label for="inpProvName">Provider name</label><input id="inpProvName" type="text" placeholder="e.g., JioTV – Family List" required></div>
      <div id="rowUrl" class="field"><label for="inpProvUrl">M3U URL</label><input id="inpProvUrl" type="url" placeholder="https://example.com/list.m3u"></div>
      <div id="rowFile" class="field hidden"><label for="inpProvFile">M3U File</label><input id="inpProvFile" type="file" accept=".m3u,.m3u8,.txt"></div>
      <div class="hint">You can edit later to change name or switch URL/File.</div>
      <div class="modal-actions">
        <button id="modalCancel" class="btn">Cancel</button>
        <button id="modalSave" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // ----------------------------
  // State & Storage
  // ----------------------------
  const LS_KEY = 'm3u_providers_v1';
  const state = {
    providers: [],
    editingId: null,
    currentProviderId: null,
    currentChannels: [],
    currentStream: null, // {title, url, type, logo}
    hls: null,
    shakaPlayer: null
  };
  
	// ---------------------------------------
	// Favorites helper functions (localStorage)
	// ---------------------------------------
	const FAV_KEY = "m3u_favorites";

	function getFavorites() {
	  try {
		return JSON.parse(localStorage.getItem(FAV_KEY)) || [];
	  } catch {
		return [];
	  }
	}

	function saveFavorites(arr) {
	  localStorage.setItem(FAV_KEY, JSON.stringify(arr));
	}

	function isFavorite(url) {
	  return getFavorites().includes(url);
	}

	function toggleFavorite(url) {
	  let favs = getFavorites();
	  if (favs.includes(url)) {
		favs = favs.filter(function (f) { return f !== url; });
	  } else {
		favs.push(url);
	  }
	  saveFavorites(favs);
	}


  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  function loadProviders(){
    try{
      state.providers = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
    }catch{ state.providers = []; }
    renderProviders();
  }
  function saveProviders(){
    localStorage.setItem(LS_KEY, JSON.stringify(state.providers));
    renderProviders();
  }

	function renderProviders() {
	  const list = document.getElementById("providersList");
	  list.innerHTML = ""; // clear old list first

	  // ---------- Add "⭐ My Favorites" card ----------
	  const favCard = document.createElement("div");
	  favCard.className = "prov-card fav-card";
	  favCard.innerHTML = `
		<div class="prov-name">⭐ My Favorites</div>
		<div class="prov-meta">Play your saved favorite channels</div>
	  `;
	  favCard.addEventListener("click", function () {
		loadFavoriteChannels();
	  });
	  list.appendChild(favCard);

	  // ---------- Now render all saved providers ----------
	  if (!state.providers.length) {
		document.getElementById("providersEmpty").classList.remove("hidden");
	  } else {
		document.getElementById("providersEmpty").classList.add("hidden");
	  }

	  state.providers.forEach(function (p) {
		const card = document.createElement("div");
		card.className = "prov-card";
		card.innerHTML = `
		  <div class="prov-name">${escapeHtml(p.name)}</div>
		  <div class="prov-meta">Source: ${p.sourceType.toUpperCase()} ${
			p.sourceType === "url" ? "· " + escapeHtml(p.url) : ""
		  }</div>
		  <div class="prov-actions">
			<button class="btn btn-primary" data-action="open" data-id="${p.id}">Open</button>
			<button class="btn" data-action="edit" data-id="${p.id}">Edit</button>
			<button class="btn btn-danger" data-action="del" data-id="${p.id}">Delete</button>
		  </div>`;
		list.appendChild(card);
	  });
	}


  function upsertProvider({id,name,sourceType,url,fileContent}){
    const now = Date.now();
    if(id){
      const idx = state.providers.findIndex(x=>x.id===id);
      if(idx>-1){
        state.providers[idx] = {...state.providers[idx], name, sourceType, url: sourceType==='url'?url:null, fileContent: sourceType==='file'?fileContent:null, updatedAt: now};
      }
    } else {
      state.providers.push({id:crypto.randomUUID(), name, sourceType, url: sourceType==='url'?url:null, fileContent: sourceType==='file'?fileContent:null, createdAt: now, updatedAt: now});
    }
    saveProviders();
  }

  function deleteProvider(id){
    state.providers = state.providers.filter(p=>p.id!==id);
    saveProviders();
  }

  // ----------------------------
  // M3U Parsing & Type Detection
  // ----------------------------
  function detectType(url){
    if(!url) return 'UNKNOWN';
    const u = url.split('?')[0].toLowerCase();
    if(u.endsWith('.m3u8')) return 'HLS';
    if(u.endsWith('.mpd')) return 'DASH';
    return 'UNKNOWN';
  }

  function parseM3U(text){
    // Returns array of { title, url, logo, type }
    const lines = text.split(/\r?\n/);
    const out = [];
    let current = null;
    for(let i=0;i<lines.length;i++){
      const line = lines[i].trim();
      if(!line) continue;
      if(line.startsWith('#EXTINF')){
        current = { title: 'Untitled', url: '', logo: '' };
        // Extract title after comma
        const comma = line.indexOf(',');
        if(comma!==-1) current.title = line.substring(comma+1).trim() || 'Untitled';
        // Extract attributes e.g., tvg-logo, logo
        const attrs = extractAttrs(line);
        current.logo = attrs['tvg-logo'] || attrs['logo'] || '';
      } else if(line.startsWith('#')) {
        // Ignore other tags but allow KODIPROP / others if needed later
        continue;
      } else {
        if(current){
          current.url = line;
          current.type = detectType(current.url);
          out.push(current);
          current = null;
        }
      }
    }
    return out;
  }

  function extractAttrs(extinfLine){
    const attrObj = {};
    const attrRegex = /(\w[\w-]*)\s*=\s*"([^"]*)"/g;
    let m; while((m = attrRegex.exec(extinfLine))){ attrObj[m[1]] = m[2]; }
    return attrObj;
  }

  // ----------------------------
  // Views Routing
  // ----------------------------
  const VIEWS = { providers: '#viewProviders', channels: '#viewChannels', player: '#viewPlayer' };
  function showView(name){
    Object.values(VIEWS).forEach(sel=>$(sel).classList.remove('active'));
    $(VIEWS[name]).classList.add('active');
  }

  // ----------------------------
  // Providers actions
  // ----------------------------
  $('#providersList').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const id = btn.dataset.id;
    const p = state.providers.find(x=>x.id===id);
    if(!p) return;
    const action = btn.dataset.action;
    if(action==='open'){
      state.currentProviderId = id;
      $('#currentProviderName').textContent = p.name;
      await loadProviderChannels(p);
      showView('channels');
    }
    if(action==='edit'){
      openProviderModal(p);
    }
    if(action==='del'){
      if(confirm('Delete this provider?')){ deleteProvider(id); }
    }
  });

  $('#backToProviders').addEventListener('click', ()=>{ showView('providers'); cleanupPlayer(); });
	// Refresh current provider's channels
	document.getElementById("refreshProvider").addEventListener("click", async function () {
	  const provider = state.providers.find(function (x) {
		return x.id === state.currentProviderId;
	  });

	  if (!provider) {
		alert("Please select a provider first.");
		return;
	  }

	  // Show a small message while reloading
	  const grid = document.getElementById("channelsGrid");
	  grid.innerHTML = "<div class='empty'>Refreshing channel list...</div>";

	  try {
		await loadProviderChannels(provider, true);
	  } catch (error) {
		console.error("Error refreshing:", error);
		alert("Failed to refresh provider.");
	  }
	});


	// ---------------------------------------------------------
	// Load favorite channels from all providers
	// ---------------------------------------------------------
	async function loadFavoriteChannels() {
	  const favUrls = getFavorites();
	  const grid = document.getElementById("channelsGrid");
	  const nameBox = document.getElementById("currentProviderName");

	  if (!favUrls || favUrls.length === 0) {
		grid.innerHTML = "<div class='empty'>You haven't added any favorite channels yet.</div>";
		nameBox.textContent = "⭐ My Favorites";
		showView("channels");
		return;
	  }

	  // Collect all channels from all providers (cached if available)
	  let allChannels = [];
	  for (const provider of state.providers) {
		if (!provider.parsed || provider.parsed.length === 0) {
		  try {
			provider.parsed = await parseM3U(provider.fileContent || provider.url);
		  } catch (err) {
			console.warn("Error parsing provider:", provider.name, err);
		  }
		}
		allChannels = allChannels.concat(provider.parsed || []);
	  }

	  // Match favorites
	  const favChannels = allChannels.filter(function (ch) {
		return favUrls.includes(ch.url);
	  });

	  if (favChannels.length === 0) {
		grid.innerHTML = "<div class='empty'>Your favorite channels are not available right now.</div>";
	  } else {
		renderChannels(favChannels);
	  }

	  nameBox.textContent = "⭐ My Favorites";
	  showView("channels");
	}


  async function loadProviderChannels(provider, force){
    try{
      let text = '';
      if(provider.sourceType==='url'){
        const res = await fetch(provider.url, {cache: force? 'reload':'default'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        text = await res.text();
      } else {
        text = provider.fileContent || '';
      }
      const channels = parseM3U(text).filter(c=>c.url);
      state.currentChannels = channels;
      renderChannels(channels);
    } catch(err){
      console.error(err);
      state.currentChannels = [];
      renderChannels([]);
    }
  }

  function renderChannels(chs){
  
	// --------------------------------------
	// Channel search and live filtering
	// --------------------------------------
	//const searchBox = document.getElementById("searchChannel");

    const grid = $('#channelsGrid');
    grid.innerHTML = '';
    const empty = $('#channelsEmpty');
    if(!chs.length){ empty.classList.remove('hidden'); return; }
    empty.classList.add('hidden');
    chs.forEach((c,idx)=>{
      const el = document.createElement('div');
      el.className = 'card';
	  
	// Determine if this channel is favorite
	const isFav = isFavorite(c.url);

	el.innerHTML = `
	  <div class="thumb">
		${ c.logo ? `<img src="${escapeAttr(c.logo)}" alt="${escapeAttr(c.title)} logo">`
				   : `<div style="color:#666">No Logo</div>` }

		<!-- HLS/DASH tag on top-left -->
		<span class="stream-tag ${c.type.toLowerCase()}">${c.type}</span>

		<!-- Favorite star on top-right -->
		<button class="fav-btn" data-url="${escapeAttr(c.url)}">
		  ${ isFav ? "★" : "☆" }
		</button>
	  </div>

	  <div class="card-body">
		<div class="title">${escapeHtml(c.title)}</div>
	  </div>`;


	el.addEventListener("click", function (event) {
	  // If the click was on the star:
	  //   - Do NOT start playback
	  //   - Do NOT stopPropagation (let it bubble to the parent handler that toggles favorites)
	  if (event.target.closest(".fav-btn")) {
		return;
	  }

	  // Otherwise, play the channel
	  startPlayback(c);
	});

      grid.appendChild(el);
    });
	
	// Apply current filters after rendering
	if (typeof filterChannels === "function") {
	  filterChannels();
	}

  }
  
	// ------------------------------------------------------
	// Favorite button click handler (works reliably)
	// ------------------------------------------------------
	const channelGrid = document.getElementById("channelsGrid");

	channelGrid.addEventListener("click", function (event) {
	  const favButton = event.target.closest(".fav-btn");
	  if (!favButton) return; // Clicked somewhere else

	  // Stop from triggering channel playback
	  event.stopPropagation();
	  event.preventDefault();

	  const url = favButton.dataset.url;

	  // Toggle favorite state
	  toggleFavorite(url);

	  // Update visual star
	  if (isFavorite(url)) {
		favButton.textContent = "★";
		favButton.classList.add("active");
		showToast("Added to Favorites");
	  } else {
		favButton.textContent = "☆";
		favButton.classList.remove("active");
		showToast("Removed from Favorites");
	  }

	  // Update filtering if favorites-only toggle is ON
	  if (typeof filterChannels === "function") {
		filterChannels();
	  }
	});




  function renderTypeTag(type){
    const t = (type||'UNKNOWN').toUpperCase();
    const cls = t==='HLS' ? 'hls' : t==='DASH' ? 'dash' : 'unk';
    return `<span class="tag ${cls}">${t}</span>`;
  }

  // ----------------------------
  // Player
  // ----------------------------
  async function startPlayback(item){
    cleanupPlayer();
    state.currentStream = item;
    $('#playerTitle').textContent = item.title || 'Untitled';
	
	// Update favorite button on player
	const favBtn = document.getElementById("favInPlayer");
	if (isFavorite(item.url)) {
	  favBtn.textContent = "★";
	  favBtn.classList.add("active");
	} else {
	  favBtn.textContent = "☆";
	  favBtn.classList.remove("active");
	}

	
    const t = (item.type||'UNKNOWN').toUpperCase();
    const badge = $('#playerTypeBadge');
    badge.textContent = t;
    badge.className = 'tag ' + (t==='HLS'?'hls':t==='DASH'?'dash':'unk') + ' player-type';

	// Save current scroll position of channel list
	const channelList = document.getElementById("channelsGrid");
	state.lastScrollY = channelList.scrollTop || window.scrollY || 0;


    showView('player');
    const video = $('#video');
    video.style.objectFit = 'contain';

	if (t === 'HLS') {
	  if (Hls.isSupported()) {
		state.hls = new Hls({
		  enableWorker: true,
		  lowLatencyMode: true
		});

		state.hls.attachMedia(video);

		// When media is attached, load the source
		state.hls.on(Hls.Events.MEDIA_ATTACHED, function () {
		  state.hls.loadSource(item.url);
		});

		// When the manifest is parsed, start playback automatically
		state.hls.on(Hls.Events.MANIFEST_PARSED, function () {
		  buildHlsControls();
		  // Try to play video automatically
		  video.play().catch(function (err) {
			console.warn("Autoplay prevented:", err);
		  });
		});
	  } 
	  else if (video.canPlayType("application/vnd.apple.mpegurl")) {
		video.src = item.url;
		video.addEventListener("loadedmetadata", function () {
		  video.play().catch(function (err) {
			console.warn("Autoplay prevented:", err);
		  });
		});
	  } 
	  else {
		alert("HLS is not supported in this browser.");
	  }
	}
	else if (t === 'DASH') {
	  try {
		state.shakaPlayer = new shaka.Player(video);
		await state.shakaPlayer.load(item.url);

		buildShakaControls();

		// Try to play video automatically
		video.play().catch(function (err) {
		  console.warn("Autoplay prevented:", err);
		});
	  } 
	  catch (e) {
		console.error(e);
		alert("Failed to load DASH stream. See console.");
	  }
	}
  }

  function cleanupPlayer(){
    const video = $('#video');
    if(state.hls){
      try{ state.hls.destroy(); }catch{}
      state.hls = null;
    }
    if(state.shakaPlayer){
      try{ state.shakaPlayer.destroy(); }catch{}
      state.shakaPlayer = null;
    }
    video.pause();
    video.removeAttribute('src');
    video.load();
    $('#settingsPanel').classList.remove('open');
  }

  // Back buttons
  $('#backToChannels').addEventListener('click', function () {
	  cleanupPlayer();
	  showView('channels');

	  // Restore previous scroll position
	  const channelList = document.getElementById("channelsGrid");
	  if (state.lastScrollY) {
		channelList.scrollTo(0, state.lastScrollY);
		window.scrollTo(0, state.lastScrollY);
	  }
	});


  // ----------------------------
  // Player Settings (common)
  // ----------------------------
  $('#btnSettings').addEventListener('click', ()=>{
    $('#settingsPanel').classList.toggle('open');
  });

  $('#selAspect').addEventListener('change', (e)=>{
    $('#video').style.objectFit = e.target.value;
  });

  // ----- HLS Controls -----
  function buildHlsControls(){
    const hls = state.hls; if(!hls) return;
    const selQ = $('#selQuality');
    const selA = $('#selAudio');
    const selS = $('#selSubs');
    const chkS = $('#chkSubs');

    // Quality levels
    selQ.innerHTML = '';
    const autoOpt = new Option('Auto', '-1'); selQ.add(autoOpt);
    hls.levels.forEach((lvl, i)=>{
      const label = lvl.height ? `${lvl.height}p` : (lvl.bitrate? Math.round(lvl.bitrate/1000)+' kbps' : 'Level '+i);
      selQ.add(new Option(label, String(i)));
    });
    selQ.onchange = ()=>{ hls.currentLevel = Number(selQ.value); };

    // Audio tracks
    selA.innerHTML = '';
    hls.audioTracks.forEach((t, i)=>{
      selA.add(new Option(`${t.name||t.lang||'Track'} ${t.lang? '('+t.lang+')':''}`, String(i)));
    });
    selA.onchange = ()=>{ hls.audioTrack = Number(selA.value); };
    // Select current
    selA.value = String(hls.audioTrack);

    // Subtitles (Text Tracks)
    selS.innerHTML = '';
    const video = $('#video');
    const tracks = Array.from(video.textTracks || []);
    if(tracks.length){
      tracks.forEach((t, i)=> selS.add(new Option(`${t.label||t.language||'Sub '+i}`, String(i))));
      chkS.onchange = ()=>{
        tracks.forEach((t, i)=>{ t.mode = (chkS.checked && selS.value==String(i))? 'showing':'disabled'; });
      };
      selS.onchange = ()=>{
        tracks.forEach((t, i)=>{ t.mode = (chkS.checked && selS.value==String(i))? 'showing':'disabled'; });
      };
    } else {
      selS.add(new Option('No subtitles', ''));
      chkS.checked = false;
    }
  }

  // ----- Shaka Controls -----
  function buildShakaControls(){
    const p = state.shakaPlayer; if(!p) return;
    const selQ = $('#selQuality');
    const selA = $('#selAudio');
    const selS = $('#selSubs');
    const chkS = $('#chkSubs');

    // Video qualities (variant tracks)
    selQ.innerHTML = '';
    const variants = p.getVariantTracks();
    const qMap = new Map();
    variants.forEach((v,i)=>{
      const label = v.height ? `${v.height}p` : `${Math.round((v.bandwidth||0)/1000)} kbps`;
      const key = `${v.id}`;
      if(!qMap.has(key)) qMap.set(key, {label, track:v});
    });
    selQ.add(new Option('Auto', 'auto'));
    [...qMap.values()].forEach(({label,track})=> selQ.add(new Option(label, String(track.id))));
    selQ.onchange = ()=>{
      if(selQ.value==='auto'){ p.configure({abr:{enabled:true}}); }
      else {
        p.configure({abr:{enabled:false}});
        const id = Number(selQ.value);
        const track = p.getVariantTracks().find(t=>t.id===id);
        if(track) p.selectVariantTrack(track, /* clearBuffer */ true, /* safeMargin */ 0);
      }
    };

    // Audio tracks / languages
    selA.innerHTML = '';
    const auds = p.getVariantTracks().reduce((acc,t)=>{ if(t.audioId||t.language){ acc.push(t); } return acc; }, []);
    const seen = new Set();
    auds.forEach((t)=>{
      const label = `${t.language||'und'}${t.channelsCount? ' · '+t.channelsCount+'ch':''}`;
      if(seen.has(label)) return; seen.add(label);
      selA.add(new Option(label, label));
    });
    selA.onchange = ()=>{
      const lang = selA.value.split(' · ')[0];
      p.selectAudioLanguage(lang);
    };

    // Subtitles (text tracks)
    selS.innerHTML = '';
    const texts = p.getTextTracks();
    if(texts.length){
      texts.forEach(t=> selS.add(new Option(`${t.language||t.kind||'sub'}`, String(t.id))));
      chkS.onchange = ()=>{
        p.setTextTrackVisibility(chkS.checked);
        if(chkS.checked && selS.value){
          const id = Number(selS.value);
          const t = p.getTextTracks().find(x=>x.id===id);
          if(t) p.selectTextTrack(t);
        }
      };
      selS.onchange = ()=>{
        if(!chkS.checked) return; const id = Number(selS.value);
        const t = p.getTextTracks().find(x=>x.id===id);
        if(t){ p.setTextTrackVisibility(true); p.selectTextTrack(t); }
      };
    } else {
      selS.add(new Option('No subtitles', ''));
      chkS.checked = false;
    }
  }

  // ----------------------------
  // Add/Edit Provider Modal
  // ----------------------------
  const modal = {
    open(data){
      $('#modalBackdrop').style.display = 'flex';
      $('#modalTitle').textContent = data?.id ? 'Edit Provider' : 'Add Provider';
      state.editingId = data?.id || null;
      // Default type
      const type = data?.sourceType || 'url';
      $$('input[name="provType"]').forEach(r=> r.checked = r.value===type);
      toggleProvType(type);
      // Prefill
      $('#inpProvName').value = data?.name || '';
      $('#inpProvUrl').value = data?.url || '';
      $('#inpProvFile').value = '';
    },
    close(){ $('#modalBackdrop').style.display = 'none'; }
  };

  function openProviderModal(data){ modal.open(data||null); }

  function toggleProvType(type){
    if(type==='file'){ $('#rowFile').classList.remove('hidden'); $('#rowUrl').classList.add('hidden'); }
    else { $('#rowUrl').classList.remove('hidden'); $('#rowFile').classList.add('hidden'); }
  }

  $$('input[name="provType"]').forEach(r=> r.addEventListener('change', e=> toggleProvType(e.target.value)));
  $('#modalClose').addEventListener('click', ()=> modal.close());
  $('#modalCancel').addEventListener('click', ()=> modal.close());

  $('#modalSave').addEventListener('click', async ()=>{
    const name = $('#inpProvName').value.trim();
    const type = $$('input[name="provType"]').find(r=>r.checked).value;
    if(!name){ alert('Please enter a provider name'); return; }

    if(type==='url'){
      const url = $('#inpProvUrl').value.trim();
      if(!url){ alert('Please enter M3U URL'); return; }
      upsertProvider({id: state.editingId, name, sourceType:'url', url});
      modal.close();
      return;
    }
    // file
    const file = $('#inpProvFile').files[0];
    if(!file && !state.editingId){ alert('Please choose a file'); return; }
    if(file){
      const content = await file.text();
      upsertProvider({id: state.editingId, name, sourceType:'file', fileContent: content});
    } else {
      // editing existing file-type without changing file
      const existing = state.providers.find(p=>p.id===state.editingId);
      if(!existing){ alert('Missing file provider'); return; }
      upsertProvider({id: state.editingId, name, sourceType:'file', fileContent: existing.fileContent});
    }
    modal.close();
  });

  // Add Provider FAB
  $('#btnAddProvider').addEventListener('click', ()=> openProviderModal());

  // ----------------------------
  // Utility
  // ----------------------------
  function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c] )); }
  
	// ------------------------------------------------
	// Toast message function
	// ------------------------------------------------
	function showToast(message) {
	  const toast = document.getElementById("toastBox");
	  if (!toast) return;

	  toast.textContent = message;
	  toast.classList.add("show");

	  // Hide after 2 seconds
	  setTimeout(function () {
		toast.classList.remove("show");
	  }, 2000);
	}

	// ----------------------------------------------------
	// Global: Combined Search + Favorites Filter
	// ----------------------------------------------------
	function filterChannels() {
	  const searchBox = document.getElementById("searchChannel");
	  const favToggle = document.getElementById("toggleFavorites");
	  const query = (searchBox ? searchBox.value : "").toLowerCase().trim();
	  const showFavOnly = favToggle ? favToggle.checked : false;

	  const cards = document.querySelectorAll("#channelsGrid .card");

	  cards.forEach(function (card) {
		const titleElement = card.querySelector(".title");
		const favButton = card.querySelector(".fav-btn");
		const titleText = titleElement ? titleElement.textContent.toLowerCase() : "";
		const url = favButton ? favButton.dataset.url : "";

		const matchesSearch = titleText.includes(query);
		const matchesFav = !showFavOnly || isFavorite(url);

		card.style.display = (matchesSearch && matchesFav) ? "flex" : "none";
	  });
	}

  function escapeAttr(s=''){ return s.replace(/"/g,'&quot;'); }

  // Close settings if clicked outside
  document.addEventListener('click', (e)=>{
    const panel = $('#settingsPanel');
    const gear = $('#btnSettings');
    if(panel.classList.contains('open')){
      if(!panel.contains(e.target) && e.target!==gear){ panel.classList.remove('open'); }
    }
  });

  // Init
  loadProviders();
  
  // Ensure settings gear visible even in fullscreen mode
	const videoElement = document.getElementById("video");

// ----------------------------------------------------
// FIXED: Gear icon visibility system (works fullscreen)
// ----------------------------------------------------
(function setupGearOverlay() {
  const gear = document.getElementById("btnSettings");
  const video = document.getElementById("video");
  const settingsPanel = document.getElementById("settingsPanel");
  let hideTimer = null;

  // Initially hide gear
  gear.style.opacity = "0";
  gear.style.transition = "opacity 0.3s";

  // Helper to show gear briefly
  function showGear() {
    gear.style.opacity = "1";
    if (hideTimer) clearTimeout(hideTimer);
    hideTimer = setTimeout(function () {
      if (!settingsPanel.classList.contains("open")) {
        gear.style.opacity = "0";
      }
    }, 4000);
  }

  // Show on video interaction
  ["click", "mousemove", "touchstart"].forEach(function (evt) {
    video.addEventListener(evt, showGear);
  });

  // When fullscreen changes, keep gear on top corner
  document.addEventListener("fullscreenchange", function () {
    const isFull = !!document.fullscreenElement;
    if (isFull) {
      gear.style.position = "fixed";
      gear.style.top = "14px";
      gear.style.right = "14px";
      gear.style.zIndex = "9999";
      gear.style.background = "rgba(0,0,0,0.5)";
      gear.style.border = "1px solid rgba(255,255,255,0.3)";
      gear.style.color = "#fff";
    } else {
      gear.style.position = "";
      gear.style.top = "";
      gear.style.right = "";
      gear.style.zIndex = "";
      gear.style.background = "";
      gear.style.border = "";
      gear.style.color = "";
    }
  });

  // Keep visible when opening settings panel
  gear.addEventListener("click", function () {
    showGear();
  });
})();


// ---------------------------------------------
// Favorite toggle from player header
// ---------------------------------------------
document.getElementById("favInPlayer").addEventListener("click", function () {
  if (!state.currentStream) return;
  const url = state.currentStream.url;

  toggleFavorite(url);

  const btn = document.getElementById("favInPlayer");
  if (isFavorite(url)) {
    btn.textContent = "★";
    btn.classList.add("active");
  } else {
    btn.textContent = "☆";
    btn.classList.remove("active");
  }
});

	// Wire search and favorites-only toggle once
	(function setupFiltersOnce() {
	  const searchBox = document.getElementById("searchChannel");
	  const favToggle = document.getElementById("toggleFavorites");

	  if (searchBox) {
		searchBox.addEventListener("input", filterChannels);
	  }
	  if (favToggle) {
		favToggle.addEventListener("change", filterChannels);
	  }
	})();


})();
</script>
<!-- Toast Notification -->
<div id="toastBox" class="toast"></div>

</body>
</html>
