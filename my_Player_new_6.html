<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M3U Player – HLS.js + Shaka</title>
  <!-- Icons -->
  <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23000'/><text x='50' y='60' font-size='60' text-anchor='middle' fill='%23fff'>▶</text></svg>">
  <!-- External libs -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.9.6/shaka-player.compiled.min.js"></script>
  <style>
    :root{
      --bg:#0b0b0f; --bg-soft:#111116; --panel:#16161d; --accent:#e50914; --text:#ececf1; --muted:#a0a0b8; --card:#1b1b24;
      --tag-hls:#2ecc71; --tag-dash:#3498db; --tag-unk:#f1c40f;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial}
    a{color:inherit}
    button{cursor:pointer}

    /* Layout */
    .app{max-width:1200px;margin:0 auto;padding:24px}
    .header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    .brand{font-weight:800;letter-spacing:.3px}
    .spacer{flex:1}
    .ghost{background:transparent;border:1px solid #2a2a36;color:var(--text);border-radius:999px;padding:8px 14px}

    /* Panels */
    .panel{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}

    /* Provider list */
    .providers-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .providers{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
    .prov-card{background:var(--card);border:1px solid #242433;border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:10px;box-shadow:var(--shadow)}
    .prov-name{font-weight:700}
    .prov-meta{color:var(--muted);font-size:13px}
    .prov-actions{display:flex;gap:8px}
    .btn{border:none;padding:10px 14px;border-radius:12px;background:#2a2a36;color:#fff}
    .btn:hover{background:#323247}
    .btn-danger{background:#521b1f}
    .btn-danger:hover{background:#6a242a}
    .btn-primary{background:var(--accent)}
    .btn-primary:hover{filter:brightness(1.1)}
    .float-add{position:fixed;right:24px;bottom:24px;width:56px;height:56px;border-radius:50%;display:grid;place-items:center;background:var(--accent);box-shadow:var(--shadow);border:none;font-size:26px;color:#fff}

    /* Channels grid */
    .channels-grid {
	  display: grid;
	  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
	  gap: 16px;
	}

	/* Force at least 3 columns in portrait phones */
	@media (max-width: 720px) {
	  .channels-grid {
		grid-template-columns: repeat(3, 1fr);
	  }
	  .card .thumb {
		height: 100px;
	  }
	  .title {
		font-size: 13px;
	  }
	}

    .card{background:var(--card);border:1px solid #242433;border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .thumb{background:#0e0e12;display:grid;place-items:center;height:120px}
    .thumb img{max-width:100%;max-height:100%;object-fit:contain}
    .card-body{padding:12px;display:flex;align-items:center;gap:8px}
    .title{font-weight:700;flex:1}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px}
    .tag.hls{background:var(--tag-hls);color:#071f11}
    .tag.dash{background:var(--tag-dash);color:#041321}
    .tag.unk{background:var(--tag-unk);color:#221a02}

    /* Views */
    .view{display:none}
    .view.active{display:block}

    /* Player */
    .player-wrap{position:relative;background:#000;border-radius:16px;overflow:hidden}
    .player-header{display:flex;align-items:center;gap:10px;padding:10px;background:linear-gradient(180deg, rgba(0,0,0,.7), rgba(0,0,0,.2));position:absolute;left:0;right:0;top:0;z-index:3}
    .back {
	  background: rgba(255, 255, 255, 0.15);
	  border: 1px solid rgba(255, 255, 255, 0.3);
	  color: #fff;
	  padding: 8px 14px;
	  border-radius: 12px;
	  font-weight: 600;
	  backdrop-filter: blur(6px);
	}


    .player-title{font-weight:700}
    .player-type{margin-left:auto}
    video{width:100%;height:70vh;background:#000;object-fit:contain}

    /* Settings popover */
	.gear {
	  margin-left: 8px;
	  background: rgba(255, 255, 255, 0.15);
	  border: 1px solid rgba(255, 255, 255, 0.3);
	  color: #fff;
	  padding: 8px 12px;
	  border-radius: 12px;
	  backdrop-filter: blur(6px);
	}
    .settings{position:absolute;right:12px;top:56px;background:#0f0f14;border:1px solid #2a2a36;border-radius:14px;box-shadow:var(--shadow);padding:12px;min-width:260px;z-index:4;display:none}
    .settings.open{display:block}
    .settings h4{margin:6px 0 10px 0;font-size:14px;color:#cfcfe6}
    .field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
    .field label{font-size:12px;color:var(--muted)}
    select, input[type="text"], input[type="url"]{background:#161620;border:1px solid #2a2a36;color:#fff;border-radius:10px;padding:8px}

    /* Modal (Netflix-style) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:10}
    .modal{background:#0f0f14;border:1px solid #2a2a36;border-radius:16px;box-shadow:var(--shadow);width:min(520px,92%);padding:18px}
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .radio-row{display:flex;gap:12px;margin:8px 0}
    .hidden{display:none !important}
    .hint{font-size:12px;color:var(--muted)}

    /* Empty states */
    .empty{border:1px dashed #2a2a36;border-radius:16px;padding:22px;text-align:center;color:var(--muted)}

    @media (max-width:720px){
      video{height:56vh}
      .player-header{gap:6px}
      .player-title{font-size:14px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="brand">M3U Player</div>
      <div class="spacer"></div>
      <button id="btnGoHome" class="ghost" title="Go to Providers" aria-label="Providers">Providers</button>
    </div>

    <!-- PROVIDERS VIEW -->
    <section id="viewProviders" class="view active">
      <div class="panel">
        <div class="providers-header">
          <h2 style="margin:0">Providers</h2>
          <div class="hint">Saved to your browser (localStorage)</div>
        </div>
        <div id="providersList" class="providers"></div>
        <div id="providersEmpty" class="empty hidden">No providers yet. Click the <b>+</b> button to add one from URL or File.</div>
      </div>
      <button id="btnAddProvider" class="float-add" title="Add Provider" aria-label="Add Provider">+</button>
    </section>

    <!-- CHANNELS VIEW -->
    <section id="viewChannels" class="view">
      <div class="panel" style="margin-bottom:14px;display:flex;align-items:center;gap:10px">
        <button id="backToProviders" class="btn">← Providers</button>
        <div id="currentProviderName" style="font-weight:700"></div>
        <div class="spacer"></div>
        <button id="refreshProvider" class="ghost">Refresh</button>
      </div>
      <div id="channelsGrid" class="channels-grid"></div>
      <div id="channelsEmpty" class="empty hidden">Could not load or parse channels from this provider.</div>
    </section>

    <!-- PLAYER VIEW -->
    <section id="viewPlayer" class="view">
      <div class="player-wrap">
        <div class="player-header">
          <button id="backToChannels" class="back">← Back</button>
          <div id="playerTitle" class="player-title"></div>
          <span id="playerTypeBadge" class="tag unk player-type">UNKNOWN</span>
          <button id="btnSettings" class="gear" title="Player settings">⚙</button>
        </div>
        <video id="video" playsinline controls></video>
        <div id="settingsPanel" class="settings" role="dialog" aria-modal="true">
          <h4>Player Settings</h4>
          <div class="field">
            <label for="selAspect">Display mode</label>
            <select id="selAspect">
              <option value="contain">Best fit</option>
              <option value="cover">Fill screen</option>
              <option value="none">Original</option>
            </select>
          </div>
          <div class="field">
            <label for="selQuality">Video quality</label>
            <select id="selQuality"></select>
          </div>
          <div class="field">
            <label for="selAudio">Audio track</label>
            <select id="selAudio"></select>
          </div>
          <div class="field">
            <label><input type="checkbox" id="chkSubs"> Subtitles (text tracks)</label>
            <select id="selSubs"></select>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Add/Edit Provider Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <h3 id="modalTitle" style="margin:0">Add Provider</h3>
        <button id="modalClose" class="ghost">✕</button>
      </div>
      <div class="radio-row">
        <label><input type="radio" name="provType" value="url" checked> From URL</label>
        <label><input type="radio" name="provType" value="file"> From File</label>
      </div>
      <div class="field"><label for="inpProvName">Provider name</label><input id="inpProvName" type="text" placeholder="e.g., JioTV – Family List" required></div>
      <div id="rowUrl" class="field"><label for="inpProvUrl">M3U URL</label><input id="inpProvUrl" type="url" placeholder="https://example.com/list.m3u"></div>
      <div id="rowFile" class="field hidden"><label for="inpProvFile">M3U File</label><input id="inpProvFile" type="file" accept=".m3u,.m3u8,.txt"></div>
      <div class="hint">You can edit later to change name or switch URL/File.</div>
      <div class="modal-actions">
        <button id="modalCancel" class="btn">Cancel</button>
        <button id="modalSave" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // ----------------------------
  // State & Storage
  // ----------------------------
  const LS_KEY = 'm3u_providers_v1';
  const state = {
    providers: [],
    editingId: null,
    currentProviderId: null,
    currentChannels: [],
    currentStream: null, // {title, url, type, logo}
    hls: null,
    shakaPlayer: null
  };

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  function loadProviders(){
    try{
      state.providers = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
    }catch{ state.providers = []; }
    renderProviders();
  }
  function saveProviders(){
    localStorage.setItem(LS_KEY, JSON.stringify(state.providers));
    renderProviders();
  }

  function renderProviders(){
    const list = $('#providersList');
    list.innerHTML = '';
    if(!state.providers.length){
      $('#providersEmpty').classList.remove('hidden');
    } else {
      $('#providersEmpty').classList.add('hidden');
    }
    state.providers.forEach(p => {
      const card = document.createElement('div');
      card.className = 'prov-card';
      card.innerHTML = `
        <div class="prov-name">${escapeHtml(p.name)}</div>
        <div class="prov-meta">Source: ${p.sourceType.toUpperCase()} ${p.sourceType==='url' ? '· ' + escapeHtml(p.url) : ''}</div>
        <div class="prov-actions">
          <button class="btn btn-primary" data-action="open" data-id="${p.id}">Open</button>
          <button class="btn" data-action="edit" data-id="${p.id}">Edit</button>
          <button class="btn btn-danger" data-action="del" data-id="${p.id}">Delete</button>
        </div>`;
      list.appendChild(card);
    });
  }

  function upsertProvider({id,name,sourceType,url,fileContent}){
    const now = Date.now();
    if(id){
      const idx = state.providers.findIndex(x=>x.id===id);
      if(idx>-1){
        state.providers[idx] = {...state.providers[idx], name, sourceType, url: sourceType==='url'?url:null, fileContent: sourceType==='file'?fileContent:null, updatedAt: now};
      }
    } else {
      state.providers.push({id:crypto.randomUUID(), name, sourceType, url: sourceType==='url'?url:null, fileContent: sourceType==='file'?fileContent:null, createdAt: now, updatedAt: now});
    }
    saveProviders();
  }

  function deleteProvider(id){
    state.providers = state.providers.filter(p=>p.id!==id);
    saveProviders();
  }

  // ----------------------------
  // M3U Parsing & Type Detection
  // ----------------------------
  function detectType(url){
    if(!url) return 'UNKNOWN';
    const u = url.split('?')[0].toLowerCase();
    if(u.endsWith('.m3u8')) return 'HLS';
    if(u.endsWith('.mpd')) return 'DASH';
    return 'UNKNOWN';
  }

  function parseM3U(text){
    // Returns array of { title, url, logo, type }
    const lines = text.split(/\r?\n/);
    const out = [];
    let current = null;
    for(let i=0;i<lines.length;i++){
      const line = lines[i].trim();
      if(!line) continue;
      if(line.startsWith('#EXTINF')){
        current = { title: 'Untitled', url: '', logo: '' };
        // Extract title after comma
        const comma = line.indexOf(',');
        if(comma!==-1) current.title = line.substring(comma+1).trim() || 'Untitled';
        // Extract attributes e.g., tvg-logo, logo
        const attrs = extractAttrs(line);
        current.logo = attrs['tvg-logo'] || attrs['logo'] || '';
      } else if(line.startsWith('#')) {
        // Ignore other tags but allow KODIPROP / others if needed later
        continue;
      } else {
        if(current){
          current.url = line;
          current.type = detectType(current.url);
          out.push(current);
          current = null;
        }
      }
    }
    return out;
  }

  function extractAttrs(extinfLine){
    const attrObj = {};
    const attrRegex = /(\w[\w-]*)\s*=\s*"([^"]*)"/g;
    let m; while((m = attrRegex.exec(extinfLine))){ attrObj[m[1]] = m[2]; }
    return attrObj;
  }

  // ----------------------------
  // Views Routing
  // ----------------------------
  const VIEWS = { providers: '#viewProviders', channels: '#viewChannels', player: '#viewPlayer' };
  function showView(name){
    Object.values(VIEWS).forEach(sel=>$(sel).classList.remove('active'));
    $(VIEWS[name]).classList.add('active');
  }

  // ----------------------------
  // Providers actions
  // ----------------------------
  $('#providersList').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const id = btn.dataset.id;
    const p = state.providers.find(x=>x.id===id);
    if(!p) return;
    const action = btn.dataset.action;
    if(action==='open'){
      state.currentProviderId = id;
      $('#currentProviderName').textContent = p.name;
      await loadProviderChannels(p);
      showView('channels');
    }
    if(action==='edit'){
      openProviderModal(p);
    }
    if(action==='del'){
      if(confirm('Delete this provider?')){ deleteProvider(id); }
    }
  });

  $('#btnGoHome').addEventListener('click', ()=>showView('providers'));
  $('#backToProviders').addEventListener('click', ()=>{ showView('providers'); cleanupPlayer(); });
  $('#refreshProvider').addEventListener('click', async ()=>{
    const p = state.providers.find(x=>x.id===state.currentProviderId);
    if(p) await loadProviderChannels(p,true);
  });

  async function loadProviderChannels(provider, force){
    try{
      let text = '';
      if(provider.sourceType==='url'){
        const res = await fetch(provider.url, {cache: force? 'reload':'default'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        text = await res.text();
      } else {
        text = provider.fileContent || '';
      }
      const channels = parseM3U(text).filter(c=>c.url);
      state.currentChannels = channels;
      renderChannels(channels);
    } catch(err){
      console.error(err);
      state.currentChannels = [];
      renderChannels([]);
    }
  }

  function renderChannels(chs){
    const grid = $('#channelsGrid');
    grid.innerHTML = '';
    const empty = $('#channelsEmpty');
    if(!chs.length){ empty.classList.remove('hidden'); return; }
    empty.classList.add('hidden');
    chs.forEach((c,idx)=>{
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="thumb">${ c.logo ? `<img src="${escapeAttr(c.logo)}" alt="${escapeAttr(c.title)} logo">` : `<div style='color:#666'>No Logo</div>` }</div>
        <div class="card-body">
          <div class="title">${escapeHtml(c.title)}</div>
          ${ renderTypeTag(c.type) }
        </div>`;
      el.addEventListener('click', ()=> startPlayback(c));
      grid.appendChild(el);
    });
  }

  function renderTypeTag(type){
    const t = (type||'UNKNOWN').toUpperCase();
    const cls = t==='HLS' ? 'hls' : t==='DASH' ? 'dash' : 'unk';
    return `<span class="tag ${cls}">${t}</span>`;
  }

  // ----------------------------
  // Player
  // ----------------------------
  async function startPlayback(item){
    cleanupPlayer();
    state.currentStream = item;
    $('#playerTitle').textContent = item.title || 'Untitled';
    const t = (item.type||'UNKNOWN').toUpperCase();
    const badge = $('#playerTypeBadge');
    badge.textContent = t;
    badge.className = 'tag ' + (t==='HLS'?'hls':t==='DASH'?'dash':'unk') + ' player-type';

	// Save current scroll position of channel list
	const channelList = document.getElementById("channelsGrid");
	state.lastScrollY = channelList.scrollTop || window.scrollY || 0;


    showView('player');
    const video = $('#video');
    video.style.objectFit = 'contain';

	if (t === 'HLS') {
	  if (Hls.isSupported()) {
		state.hls = new Hls({
		  enableWorker: true,
		  lowLatencyMode: true
		});

		state.hls.attachMedia(video);

		// When media is attached, load the source
		state.hls.on(Hls.Events.MEDIA_ATTACHED, function () {
		  state.hls.loadSource(item.url);
		});

		// When the manifest is parsed, start playback automatically
		state.hls.on(Hls.Events.MANIFEST_PARSED, function () {
		  buildHlsControls();
		  // Try to play video automatically
		  video.play().catch(function (err) {
			console.warn("Autoplay prevented:", err);
		  });
		});
	  } 
	  else if (video.canPlayType("application/vnd.apple.mpegurl")) {
		video.src = item.url;
		video.addEventListener("loadedmetadata", function () {
		  video.play().catch(function (err) {
			console.warn("Autoplay prevented:", err);
		  });
		});
	  } 
	  else {
		alert("HLS is not supported in this browser.");
	  }
	}
	else if (t === 'DASH') {
	  try {
		state.shakaPlayer = new shaka.Player(video);
		await state.shakaPlayer.load(item.url);

		buildShakaControls();

		// Try to play video automatically
		video.play().catch(function (err) {
		  console.warn("Autoplay prevented:", err);
		});
	  } 
	  catch (e) {
		console.error(e);
		alert("Failed to load DASH stream. See console.");
	  }
	}
  }

  function cleanupPlayer(){
    const video = $('#video');
    if(state.hls){
      try{ state.hls.destroy(); }catch{}
      state.hls = null;
    }
    if(state.shakaPlayer){
      try{ state.shakaPlayer.destroy(); }catch{}
      state.shakaPlayer = null;
    }
    video.pause();
    video.removeAttribute('src');
    video.load();
    $('#settingsPanel').classList.remove('open');
  }

  // Back buttons
  $('#backToChannels').addEventListener('click', function () {
	  cleanupPlayer();
	  showView('channels');

	  // Restore previous scroll position
	  const channelList = document.getElementById("channelsGrid");
	  if (state.lastScrollY) {
		channelList.scrollTo(0, state.lastScrollY);
		window.scrollTo(0, state.lastScrollY);
	  }
	});


  // ----------------------------
  // Player Settings (common)
  // ----------------------------
  $('#btnSettings').addEventListener('click', ()=>{
    $('#settingsPanel').classList.toggle('open');
  });

  $('#selAspect').addEventListener('change', (e)=>{
    $('#video').style.objectFit = e.target.value;
  });

  // ----- HLS Controls -----
  function buildHlsControls(){
    const hls = state.hls; if(!hls) return;
    const selQ = $('#selQuality');
    const selA = $('#selAudio');
    const selS = $('#selSubs');
    const chkS = $('#chkSubs');

    // Quality levels
    selQ.innerHTML = '';
    const autoOpt = new Option('Auto', '-1'); selQ.add(autoOpt);
    hls.levels.forEach((lvl, i)=>{
      const label = lvl.height ? `${lvl.height}p` : (lvl.bitrate? Math.round(lvl.bitrate/1000)+' kbps' : 'Level '+i);
      selQ.add(new Option(label, String(i)));
    });
    selQ.onchange = ()=>{ hls.currentLevel = Number(selQ.value); };

    // Audio tracks
    selA.innerHTML = '';
    hls.audioTracks.forEach((t, i)=>{
      selA.add(new Option(`${t.name||t.lang||'Track'} ${t.lang? '('+t.lang+')':''}`, String(i)));
    });
    selA.onchange = ()=>{ hls.audioTrack = Number(selA.value); };
    // Select current
    selA.value = String(hls.audioTrack);

    // Subtitles (Text Tracks)
    selS.innerHTML = '';
    const video = $('#video');
    const tracks = Array.from(video.textTracks || []);
    if(tracks.length){
      tracks.forEach((t, i)=> selS.add(new Option(`${t.label||t.language||'Sub '+i}`, String(i))));
      chkS.onchange = ()=>{
        tracks.forEach((t, i)=>{ t.mode = (chkS.checked && selS.value==String(i))? 'showing':'disabled'; });
      };
      selS.onchange = ()=>{
        tracks.forEach((t, i)=>{ t.mode = (chkS.checked && selS.value==String(i))? 'showing':'disabled'; });
      };
    } else {
      selS.add(new Option('No subtitles', ''));
      chkS.checked = false;
    }
  }

  // ----- Shaka Controls -----
  function buildShakaControls(){
    const p = state.shakaPlayer; if(!p) return;
    const selQ = $('#selQuality');
    const selA = $('#selAudio');
    const selS = $('#selSubs');
    const chkS = $('#chkSubs');

    // Video qualities (variant tracks)
    selQ.innerHTML = '';
    const variants = p.getVariantTracks();
    const qMap = new Map();
    variants.forEach((v,i)=>{
      const label = v.height ? `${v.height}p` : `${Math.round((v.bandwidth||0)/1000)} kbps`;
      const key = `${v.id}`;
      if(!qMap.has(key)) qMap.set(key, {label, track:v});
    });
    selQ.add(new Option('Auto', 'auto'));
    [...qMap.values()].forEach(({label,track})=> selQ.add(new Option(label, String(track.id))));
    selQ.onchange = ()=>{
      if(selQ.value==='auto'){ p.configure({abr:{enabled:true}}); }
      else {
        p.configure({abr:{enabled:false}});
        const id = Number(selQ.value);
        const track = p.getVariantTracks().find(t=>t.id===id);
        if(track) p.selectVariantTrack(track, /* clearBuffer */ true, /* safeMargin */ 0);
      }
    };

    // Audio tracks / languages
    selA.innerHTML = '';
    const auds = p.getVariantTracks().reduce((acc,t)=>{ if(t.audioId||t.language){ acc.push(t); } return acc; }, []);
    const seen = new Set();
    auds.forEach((t)=>{
      const label = `${t.language||'und'}${t.channelsCount? ' · '+t.channelsCount+'ch':''}`;
      if(seen.has(label)) return; seen.add(label);
      selA.add(new Option(label, label));
    });
    selA.onchange = ()=>{
      const lang = selA.value.split(' · ')[0];
      p.selectAudioLanguage(lang);
    };

    // Subtitles (text tracks)
    selS.innerHTML = '';
    const texts = p.getTextTracks();
    if(texts.length){
      texts.forEach(t=> selS.add(new Option(`${t.language||t.kind||'sub'}`, String(t.id))));
      chkS.onchange = ()=>{
        p.setTextTrackVisibility(chkS.checked);
        if(chkS.checked && selS.value){
          const id = Number(selS.value);
          const t = p.getTextTracks().find(x=>x.id===id);
          if(t) p.selectTextTrack(t);
        }
      };
      selS.onchange = ()=>{
        if(!chkS.checked) return; const id = Number(selS.value);
        const t = p.getTextTracks().find(x=>x.id===id);
        if(t){ p.setTextTrackVisibility(true); p.selectTextTrack(t); }
      };
    } else {
      selS.add(new Option('No subtitles', ''));
      chkS.checked = false;
    }
  }

  // ----------------------------
  // Add/Edit Provider Modal
  // ----------------------------
  const modal = {
    open(data){
      $('#modalBackdrop').style.display = 'flex';
      $('#modalTitle').textContent = data?.id ? 'Edit Provider' : 'Add Provider';
      state.editingId = data?.id || null;
      // Default type
      const type = data?.sourceType || 'url';
      $$('input[name="provType"]').forEach(r=> r.checked = r.value===type);
      toggleProvType(type);
      // Prefill
      $('#inpProvName').value = data?.name || '';
      $('#inpProvUrl').value = data?.url || '';
      $('#inpProvFile').value = '';
    },
    close(){ $('#modalBackdrop').style.display = 'none'; }
  };

  function openProviderModal(data){ modal.open(data||null); }

  function toggleProvType(type){
    if(type==='file'){ $('#rowFile').classList.remove('hidden'); $('#rowUrl').classList.add('hidden'); }
    else { $('#rowUrl').classList.remove('hidden'); $('#rowFile').classList.add('hidden'); }
  }

  $$('input[name="provType"]').forEach(r=> r.addEventListener('change', e=> toggleProvType(e.target.value)));
  $('#modalClose').addEventListener('click', ()=> modal.close());
  $('#modalCancel').addEventListener('click', ()=> modal.close());

  $('#modalSave').addEventListener('click', async ()=>{
    const name = $('#inpProvName').value.trim();
    const type = $$('input[name="provType"]').find(r=>r.checked).value;
    if(!name){ alert('Please enter a provider name'); return; }

    if(type==='url'){
      const url = $('#inpProvUrl').value.trim();
      if(!url){ alert('Please enter M3U URL'); return; }
      upsertProvider({id: state.editingId, name, sourceType:'url', url});
      modal.close();
      return;
    }
    // file
    const file = $('#inpProvFile').files[0];
    if(!file && !state.editingId){ alert('Please choose a file'); return; }
    if(file){
      const content = await file.text();
      upsertProvider({id: state.editingId, name, sourceType:'file', fileContent: content});
    } else {
      // editing existing file-type without changing file
      const existing = state.providers.find(p=>p.id===state.editingId);
      if(!existing){ alert('Missing file provider'); return; }
      upsertProvider({id: state.editingId, name, sourceType:'file', fileContent: existing.fileContent});
    }
    modal.close();
  });

  // Add Provider FAB
  $('#btnAddProvider').addEventListener('click', ()=> openProviderModal());

  // ----------------------------
  // Utility
  // ----------------------------
  function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c] )); }
  function escapeAttr(s=''){ return s.replace(/"/g,'&quot;'); }

  // Close settings if clicked outside
  document.addEventListener('click', (e)=>{
    const panel = $('#settingsPanel');
    const gear = $('#btnSettings');
    if(panel.classList.contains('open')){
      if(!panel.contains(e.target) && e.target!==gear){ panel.classList.remove('open'); }
    }
  });

  // Init
  loadProviders();
  
  // Ensure settings gear visible even in fullscreen mode
	const videoElement = document.getElementById("video");

	// Listen for fullscreen change events
	document.addEventListener("fullscreenchange", function () {
	  const isFull = !!document.fullscreenElement;
	  const gearBtn = document.getElementById("btnSettings");

	  if (isFull) {
		// Show gear button as overlay in corner when fullscreen
		gearBtn.style.position = "fixed";
		gearBtn.style.top = "12px";
		gearBtn.style.right = "12px";
		gearBtn.style.zIndex = "9999";
	  } else {
		// Restore normal position
		gearBtn.style.position = "";
		gearBtn.style.top = "";
		gearBtn.style.right = "";
		gearBtn.style.zIndex = "";
	  }
	});

  
})();
</script>
</body>
</html>
